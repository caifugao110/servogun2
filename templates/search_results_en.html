<!--
  Copyright [2025] [OBARA (Nanjing) Electromechanical Co., Ltd]

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->


{% extends 'base_en.html' %}
{% load static %}

{% block title %}Search Results - OBARA Welding Gun Selection Database{% endblock %}

{% block extra_css %}
<style>
    /* 1. Increase row height when search results need multiple lines for better appearance, ensure highlighted text doesn't overlap */
    .table-responsive table.table td {
        padding-top: 0.75rem; /* Increase top padding */
        padding-bottom: 0.75rem; /* Increase bottom padding */
        vertical-align: middle; /* Vertical center */
        line-height: 1.5; /* Increase line height for better multi-line text readability */
    }

    /* Ensure highlighted text doesn't look crowded in multiple lines and highlight area looks good */
    .table-responsive table.table td .highlight-field {
        /* If highlight is background color, increasing line height and padding helps visual separation */
        padding: 0.1rem 0.2rem; /* Slightly increase padding in highlight area */
        border-radius: 0.25rem; /* Slight rounded corners */
        display: inline; /* Ensure it's inline element for text wrapping */
        /* box-decoration-break property controls background, border, shadow appearance when element breaks inline */
        box-decoration-break: clone; /* Try this property, may improve multi-line highlight appearance */
        -webkit-box-decoration-break: clone; /* Webkit prefix */
    }

    /* 2. Make the three option buttons for pdf Only, STEP Only, and pdf and STEP look better, no dropdown, with borders, no conflict with original background */
    .file-type-buttons .btn {
        border-radius: 0.25rem; /* Keep button rounded corners */
        margin-right: 0.5rem; /* Spacing between buttons */
        min-width: 80px; /* Ensure consistent button width */
        /* Adjust colors for blue background to improve contrast */
        border-color: white; /* Use white for border */
        color: white; /* Use white for text */
        background-color: transparent; /* Transparent background */
        font-weight: 500; /* Slightly bold text */
        transition: all 0.2s ease; /* Add transition effect */
    }
    /* Hover effect for unselected state */
    .file-type-buttons .btn:not(.active):hover {
        background-color: rgba(255, 255, 255, 0.2); /* White semi-transparent background */
        border-color: white; /* Keep white border */
        color: white; /* Keep white text */
    }
    .file-type-buttons .btn:last-child {
        margin-right: 0; /* Last button doesn't need right margin */
    }
    /* Add right margin to button group to ensure spacing with batch download button */
    .file-type-buttons {
        margin-right: 1.5rem !important; /* Spacing with batch download button */
    }
    /* Active state button style */
    .file-type-buttons .btn.active {
        background-color: white; /* Use white as background */
        border-color: white; /* White border */
        color: var(--bs-primary); /* Primary color text */
        font-weight: 600; /* Bold text for active state */
    }
    
    /* Batch download button style - Simplified design for clear visibility */
    .batch-download-btn {
        /* Basic styles */
        padding: 0.25rem 0.75rem; /* Appropriate padding */
        margin-left: 0 !important; /* Reset left margin to avoid conflict with button group right margin */
        font-size: 0.875rem; /* Font size */
        font-weight: 600; /* Bold text */
        line-height: 1.5; /* Line height */
        border-radius: 0.25rem; /* Rounded corners */
        text-align: center; /* Centered text */
        text-decoration: none; /* No underline */
        vertical-align: middle; /* Vertically centered */
        cursor: pointer; /* Pointer cursor */
        user-select: none; /* Prevent text selection */
        border: 1px solid transparent; /* Border */
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; /* Transition effects */
        
        /* Custom colors - Ensure visibility on blue background */
        background-color: white; /* White background */
        color: #0d6efd; /* Blue text */
        border-color: white; /* White border */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* Slight shadow */
    }
    
    /* Batch download button disabled state */
    .batch-download-btn:disabled {
        background-color: rgba(255, 255, 255, 0.5); /* Semi-transparent white background */
        color: rgba(0, 0, 0, 0.5); /* Gray text */
        border-color: rgba(255, 255, 255, 0.5); /* Semi-transparent white border */
        box-shadow: none; /* Remove shadow */
        cursor: not-allowed; /* Disabled cursor */
        opacity: 0.65; /* Reduce opacity */
    }
    
    /* Batch download button hover effect */
    .batch-download-btn:not(:disabled):hover {
        background-color: #f8f9fa; /* Light gray background */
        color: #0d6efd; /* Blue text */
        border-color: white; /* White border */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Enhanced shadow */
    }

    /* Image preview style */
    .image-preview {
        transition: transform 0.2s ease;
        border: 1px solid #dee2e6;
    }
    
    .image-preview:hover {
        transform: scale(1.05);
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.25);
    }

    /* Image preview modal style */
    .modal-lg {
        max-width: 90vw;
    }
    
    #previewImage {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Reset all th styles to ensure proper header display */
    .table th {
        background-color: rgba(0, 123, 255, 0.8) !important;
        color: white !important;
        font-weight: 600 !important;
        padding: 0.75rem !important;
        text-align: center !important;
        border: none !important;
    }
    
    /* Sortable column header in light mode - match regular headers */
    .table th.highlight-field {
        background-image: none !important;
        background: none !important;
        background-color: rgba(0, 123, 255, 0.8) !important;
        color: white !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
    
    /* Sortable column header hover effect */
    .table th.highlight-field:hover {
        background-color: rgba(0, 123, 255, 1) !important;
        color: white !important;
    }
    
    /* All header styles in dark mode - ensure consistent color */
    [data-bs-theme="dark"] .table th {
        background-image: none !important;
        background: none !important;
        background-color: rgba(0, 123, 255, 0.3) !important;
        color: white !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
    
    /* Sortable column header in dark mode - match regular headers */
    [data-bs-theme="dark"] .table th.highlight-field {
        background-color: rgba(0, 123, 255, 0.3) !important;
    }
    
    /* Dark mode sortable column header hover effect */
    [data-bs-theme="dark"] .table th.highlight-field:hover {
        background-color: rgba(0, 123, 255, 0.5) !important;
        color: white !important;
    }
    
    /* Active sortable column header styles */
    .table th.highlight-field,
    .table th.highlight-field a {
        color: white !important;
        font-weight: 600 !important;
    }
    
    /* Sort link styles - ensure covers entire th area */
    .table th.highlight-field a {
        display: block !important;
        width: 100% !important;
        height: 100% !important;
        padding: 0.75rem 0.5rem !important;
        margin: -0.75rem -0.5rem !important;
        text-decoration: none !important;
        color: white !important;
        background: transparent !important;
        text-align: center !important;
    }
    
    /* Sort icon styles */
    .table th.highlight-field i {
        font-size: 0.85rem !important;
        opacity: 0.8 !important;
        color: white !important;
    }
    
    /* Ensure highlight-field styles in td are not affected */
    .table td .highlight-field {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .table td .highlight-field:hover {
        background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        transform: scale(1.05);
        border-color: var(--accent-color);
    }
    
    /* Dark mode table content styles - improve readability */
    [data-bs-theme="dark"] .table td .highlight-field {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-bs-theme="dark"] .table td .highlight-field:hover {
        background: linear-gradient(135deg, #34495e, #4a637b);
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Search Results Header -->
        <div class="results-header fade-in-up">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-search me-2"></i>
                        Search Results
                    </h2>
                    <p class="mb-0">Found {{ total_results }} matching products</p>
                </div>
                <div>
                    <a href="{% if is_style_search %}/style-search/{{ request.session.style_search_unique_id }}_en/{% else %}{% url 'clamps:search_en' %}{% endif %}" class="btn btn-light">
                        <i class="bi bi-arrow-left me-2"></i>
                        Back to Search
                    </a>
                </div>
            </div>
        </div>
        
        {% if page_obj %}
            <!-- Search Results Table -->
            <div class="card fade-in-up">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Search Results List</h5>
                    <div>
                        <div class="input-group">
                            <!-- Replace dropdown with button group -->
                            <div class="btn-group file-type-buttons" role="group" aria-label="File Type Selection">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-file-type="pdf">PDF Only</button>
                                <button type="button" class="btn btn-outline-primary btn-sm active" data-file-type="step">STEP Only</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-file-type="both">PDF and STEP</button>
                            </div>
                            <button id="batchDownloadBtn" class="batch-download-btn" disabled>
                                <i class="bi bi-download me-2"></i>Batch Download Selected
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th width="5%"><input type="checkbox" id="selectAll"></th>
                                    <th width="5%">No.</th>
                                    <th width="15%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=drawing_no_1&sort_dir={% if sort_by == 'drawing_no_1' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            Drawing No.1(o)
                                            {% if sort_by == 'drawing_no_1' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=throat_depth&sort_dir={% if sort_by == 'throat_depth' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            Throat Depth
                                            {% if sort_by == 'throat_depth' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=throat_width&sort_dir={% if sort_by == 'throat_width' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            Throat Width
                                            {% if sort_by == 'throat_width' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=transformer&sort_dir={% if sort_by == 'transformer' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            Transformer
                                            {% if sort_by == 'transformer' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=clamping_force&sort_dir={% if sort_by == 'clamping_force' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            Pressure
                                            {% if sort_by == 'clamping_force' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="15%">Preview</th>
                                    <th width="12%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in page_obj %}
                                    <tr class="product-row" data-product-id="{{ product.id }}">
                                        <td><input type="checkbox" class="product-checkbox" value="{{ product.id }}"></td>
                                        <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.drawing_no_1|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.throat_depth %}
                                                    {{ product.throat_depth }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.throat_width %}
                                                    {{ product.throat_width }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.transformer|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.clamping_force %}
                                                    {{ product.clamping_force }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            {% if product.bmp_file_path %}
                                          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZGVlMmU2Ii8+PHRleHQgeD0iMzAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkrDqMO85a+85aSnPC90ZXh0Pjwvc3ZnPg==" 
                                                     data-src="{% url 'clamps:protected_media' path=product.bmp_file_path %}" 
                                                     class="image-preview lazyload" 
                                                     onclick="previewImage('{% url 'clamps:protected_media' path=product.bmp_file_path %}', '{{ product.drawing_no_1|default:"Unknown Product" }}')"
                                                     alt="Product Preview"
                                                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 4px;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                                     title="Click to enlarge">
                                                <span class="text-muted" style="display: none;">No Image</span>
                                            {% else %}
                                                <span class="text-muted">No Image</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <a href="{% url 'clamps:product_detail_en' product.id %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-eye me-1"></i>Details
                                                </a>
                                                {% if product.pdf_file_path %}
                                                    <button onclick="downloadSingleFile({{ product.id }}, 'pdf', '{{ product.drawing_no_1|escapejs }}')" 
                                                       class="btn btn-outline-success btn-sm download-btn">
                                                        <i class="bi bi-download me-1"></i>PDF
                                                    </button>
                                                {% endif %}

                                                {% if product.step_file_path %}
                                                    <button onclick="downloadSingleFile({{ product.id }}, 'step', '{{ product.drawing_no_1|escapejs }}')" 
                                                       class="btn btn-outline-info btn-sm download-btn">
                                                        <i class="bi bi-download me-1"></i>STEP
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Search Results Pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page=1">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.previous_page_number }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.next_page_number }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <div class="text-center text-muted">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    (Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ total_results }} records)
                </div>
            {% endif %}
            
        {% else %}
            <!-- No Search Results -->
            <div class="text-center py-5 fade-in-up">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-muted">No matching products found</h3>
                        <p class="text-muted">Please try adjusting your search criteria or using different keywords</p>
                        <a href="{% if is_style_search %}/style-search/{{ request.session.style_search_unique_id }}_en/{% else %}{% url 'clamps:search_en' %}{% endif %}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-2"></i>
                            Search Again
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Search Criteria Summary -->
        {% if query_params %}
            <div class="card mt-4 fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Current Search Criteria
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for key, value in query_params.items %}
                            {% if value %}
                                <div class="col-md-3 mb-2">
                                    <span class="badge bg-primary">
                                        {{ key }}: {{ value }}
                                    </span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">
                    <i class="bi bi-image me-2"></i>
                    Product Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="previewImage" src="" alt="Product Preview" class="img-fluid" >
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/compression_async.js' %}"></script>
<script>
    // Lazy loading implementation
    document.addEventListener("DOMContentLoaded", function() {
        // Intersection Observer for lazy loading
        const lazyLoadImages = document.querySelectorAll(".lazyload");
        
        if ("IntersectionObserver" in window) {
            let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        let lazyImage = entry.target;
                        lazyImage.src = lazyImage.dataset.src;
                        lazyImage.classList.remove("lazyload");
                        lazyImageObserver.unobserve(lazyImage);
                    }
                });
            });
            
            lazyLoadImages.forEach(function(lazyImage) {
                lazyImageObserver.observe(lazyImage);
            });
        } else {
            // Fallback for browsers that don't support Intersection Observer
            let lazyLoadThrottleTimeout;
            
            function lazyLoad() {
                if (lazyLoadThrottleTimeout) {
                    clearTimeout(lazyLoadThrottleTimeout);
                }
                
                lazyLoadThrottleTimeout = setTimeout(function() {
                    const scrollTop = window.pageYOffset;
                    
                    lazyLoadImages.forEach(function(img) {
                        if (img.offsetTop < (window.innerHeight + scrollTop)) {
                            img.src = img.dataset.src;
                            img.classList.remove("lazyload");
                        }
                    });
                    
                    if (lazyLoadImages.length === 0) {
                        document.removeEventListener("scroll", lazyLoad);
                        window.removeEventListener("resize", lazyLoad);
                        window.removeEventListener("orientationChange", lazyLoad);
                    }
                }, 20);
            }
            
            document.addEventListener("scroll", lazyLoad);
            window.addEventListener("resize", lazyLoad);
            window.addEventListener("orientationChange", lazyLoad);
        }
    });
    
    function viewDetail(productId) {
        window.location.href = `/product/${productId}_en/`;
    }
    
    // Image preview functionality - enhanced version, consistent with product_detail.html
    function previewImage(imageSrc, productName) {
        const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
        const previewImg = document.getElementById('previewImage');
        const modalTitle = document.getElementById('imagePreviewModalLabel');
        
        // Set image source and title
        previewImg.src = imageSrc;
        modalTitle.innerHTML = `<i class="bi bi-image me-2"></i>Product Preview - ${productName || 'Unknown Product'}`;
        
        // Show modal
        modal.show();
        
        // Image loading error handling
        previewImg.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmU2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjNmM3NTdkIj5JbWFnZSBOb3QgRm91bmQ8L3RleHQ+PC9zdmc+';
            modalTitle.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Image Load Failed - ${productName || 'Unknown Product'}`;
        };
    }
    
    // Select all/deselect all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBatchDownloadButton();
    });
    
    // Listen to individual checkbox changes
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchDownloadButton);
    });
    
    // Update batch download button status
    function updateBatchDownloadButton() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        const batchDownloadBtn = document.getElementById('batchDownloadBtn');
        
        if (checkedBoxes.length > 0) {
            batchDownloadBtn.disabled = false;
            batchDownloadBtn.innerHTML = `<i class="bi bi-download me-2"></i>Batch Download Selected (${checkedBoxes.length})`;
        } else {
            batchDownloadBtn.disabled = true;
            batchDownloadBtn.innerHTML = '<i class="bi bi-download me-2"></i>Batch Download Selected';
        }
    }
    
    // File type button switching
    document.querySelectorAll('.file-type-buttons .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.file-type-buttons .btn').forEach(b => b.classList.remove('active'));
            // Add active class to current button
            this.classList.add('active');
        });
    });
    
    // Batch download functionality - asynchronous compression optimization
    document.getElementById('batchDownloadBtn').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        if (checkedBoxes.length === 0) {
            showToast('Please select products to download first', 'warning');
            return;
        }
        
        const productIds = Array.from(checkedBoxes).map(cb => cb.value);
        const activeFileType = document.querySelector('.file-type-buttons .btn.active').dataset.fileType;
        let isDownloadReady = false;
        
        // Check file size and existence first - completely rely on backend check
        checkBatchFileSize(productIds, activeFileType, () => {
            // Check passed, start compression and show download warning with progress
            startCompression(productIds, activeFileType, (taskId) => {
                // Show download warning with progress
                showDownloadWarning(() => {
                    // Only allow download when compression is complete
                    if (isDownloadReady) {
                        // Download completed file
                        downloadCompressedFile(taskId, activeFileType);
                    } else {
                        // If not ready, show prompt
                        showToast('Compression task is not yet complete. Please try again later', 'warning');
                    }
                }, taskId);
                
                // Start checking progress
                let progressCheckInterval = setInterval(() => {
                    checkCompressionProgress(taskId, (progress, isCompleted) => {
                        updateCompressionProgress(progress);
                        
                        // Update download button status
                        const directDownloadBtn = document.getElementById('directDownloadBtn');
                        if (directDownloadBtn) {
                            if (isCompleted) {
                                directDownloadBtn.disabled = false;
                                directDownloadBtn.innerHTML = '<i class="bi bi-download me-1"></i>Start Download';
                                isDownloadReady = true;
                                // Compression completed, start download automatically
                                clearInterval(progressCheckInterval);
                                setTimeout(() => {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('downloadWarningModal'));
                                    if (modal) {
                                        modal.hide();
                                        downloadCompressedFile(taskId, activeFileType);
                                    }
                                }, 1000);
                            } else {
                                directDownloadBtn.disabled = true;
                                directDownloadBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Compressing...(' + progress + '%)';
                            }
                        }
                    });
                }, 1000);
            });
        });
    });
    
    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    window.CSRF_TOKEN = csrftoken;
    
    // Single file download - asynchronous compression optimization
    function downloadSingleFile(productId, fileType, productName) {
        // Check file size and existence
        checkBatchFileSize([productId], fileType, () => {
            // Check passed, start compression and show download warning
            startCompression([productId], fileType, (taskId) => {
                let isDownloadReady = false;
                let requestFileType = fileType; // Save current request file type
                
                // Show download warning with progress
                showDownloadWarning(() => {
                    // Only allow download when compression is complete
                    if (isDownloadReady) {
                        // Download completed file
                        downloadCompressedFile(taskId, requestFileType);
                    } else {
                        // If not ready, show prompt
                        showToast('Compression task is not yet complete. Please try again later', 'warning');
                    }
                }, taskId);
                
                // Start checking progress
                let progressCheckInterval = setInterval(() => {
                    checkCompressionProgress(taskId, (progress, isCompleted) => {
                        updateCompressionProgress(progress);
                        
                        // Update download button status
                        const directDownloadBtn = document.getElementById('directDownloadBtn');
                        if (directDownloadBtn) {
                            if (isCompleted) {
                                directDownloadBtn.disabled = false;
                                directDownloadBtn.innerHTML = '<i class="bi bi-download me-1"></i>Start Download';
                                isDownloadReady = true;
                                // Compression completed, start download automatically
                                clearInterval(progressCheckInterval);
                                setTimeout(() => {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('downloadWarningModal'));
                                    if (modal) {
                                        modal.hide();
                                        downloadCompressedFile(taskId, requestFileType);
                                    }
                                }, 1000);
                            } else {
                                directDownloadBtn.disabled = true;
                                directDownloadBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Compressing...(' + progress + '%)';
                            }
                        }
                    });
                }, 1000);
            });
        });
    }
    
    // Check single file size
    function checkFileSize(productId, fileType, callback) {
        // Add language parameter
        const language = window.location.pathname.includes('en') || window.location.pathname.includes('_en') ? 'en' : 'zh';
        fetch(`{% url 'clamps:check_file_size' 0 'TYPE' %}`.replace('0', productId).replace('TYPE', fileType) + `?language=${language}`)
            .then(response => response.json())
            .then(data => {
                if (data.can_download) {
                    callback();
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error checking file size:', error);
                showToast('Error checking file size, please try again later', 'danger');
            });
    }
    
    // Check batch download file size - fixed to use POST request
    function checkBatchFileSize(productIds, fileType, callback) {
        // Use JSON format with CSRF header
        const requestData = {
            product_ids: productIds.join(','),
            file_type: fileType,
            language: window.location.pathname.includes('en') || window.location.pathname.includes('_en') ? 'en' : 'zh'
        };
        
        fetch('{% url "clamps:check_batch_file_size" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.CSRF_TOKEN
            },
            body: JSON.stringify(requestData),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.can_download) {
                callback();
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error checking batch file size:', error);
            showToast('Error checking file size, please try again later', 'danger');
        });
    }
    
    function showDownloadWarning(callback, taskId = null) {
        const warningHtml = `
            <div class="modal fade" id="downloadWarningModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-download me-2"></i>
                                Download Notice
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="alert" style="background-color: #e0f7fa; border: 1px solid #b2ebf2; border-radius: 8px; color: #2c3e50; padding: 12px 16px;">
                                <i class="bi bi-info-circle me-2" style="color: #2c3e50;"></i>
                                Drawing and model data may change for various reasons without notice. The selection database cannot guarantee the complete accuracy of drawing and model data, and this data should not be used as any reference basis.
                            </div>
                            <div class="text-center">
                                <div class="spinner-border text-primary me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Preparing file, please wait...</span><br>Server compression takes time when there's a lot of data, please be patient
                            </div>
                            ${taskId ? `
                            <div class="mt-3">
                                <h6>Compression Progress:</h6>
                                <div class="progress">
                                    <div id="compressionProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="directDownloadBtn" disabled>
                                <i class="bi bi-hourglass-split me-1"></i>
                                Compressing...
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal
        const existingModal = document.getElementById('downloadWarningModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', warningHtml);
        const modal = new bootstrap.Modal(document.getElementById('downloadWarningModal'));
        
        const directDownloadBtn = document.getElementById('directDownloadBtn');
        
        directDownloadBtn.addEventListener('click', () => {
            modal.hide();
            callback();
        });
        
        modal.show();
        
        // Clean up when modal is closed
        document.getElementById('downloadWarningModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('downloadWarningModal').remove();
        });
    }
    
    // Update compression progress in the modal
    function updateCompressionProgress(progress) {
        const progressElement = document.getElementById('compressionProgress');
        if (progressElement) {
            progressElement.style.width = `${progress}%`;
            progressElement.textContent = `${progress}%`;
            progressElement.setAttribute('aria-valuenow', progress);
        }
    }
    
    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="alert alert-dismissible show" role="alert" style="background-color: #e0f7fa; border: 1px solid #b2ebf2; border-radius: 8px; color: #dc3545; padding: 12px 16px; margin-bottom: 16px; z-index: 9999; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 600px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center;">
                <i class="bi bi-exclamation-circle me-2" style="color: #dc3545;"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" style="color: #dc3545; opacity: 0.7; margin-left: auto;"></button>
            </div>
        `;
        
        // Insert at the end of body with fixed positioning to center it
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        
        // Auto clean up alert element
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert.show');
            if (alerts.length > 0) {
                alerts[alerts.length - 1].remove();
            }
        }, 5000);
    }
</script>

<!-- Add CSRF token to page for JavaScript use -->
{% csrf_token %}
{% endblock %}

