<!--
  Copyright [2025] [OBARA (Nanjing) Electromechanical Co., Ltd]

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->


{% extends 'base.html' %}
{% load static %}

{% block title %}搜索结果 - 小原焊枪选型数据库{% endblock %}

{% block extra_css %}
<style>
    /* 1. 搜索结果宽度不够需要多行显示时增加行高让看起来美观一点，注意文字外部的高亮不要重叠 */
    .table-responsive table.table td {
        padding-top: 0.75rem; /* 增加顶部内边距 */
        padding-bottom: 0.75rem; /* 增加底部内边距 */
        vertical-align: middle; /* 垂直居中 */
        line-height: 1.5; /* 增加行高，让多行文本更易读 */
    }

    /* 确保高亮文本在多行时不会显得拥挤，且高亮区域美观 */
    .table-responsive table.table td .highlight-field {
        /* 如果高亮是背景色，增加行高和内边距有助于视觉分离 */
        padding: 0.1rem 0.2rem; /* 稍微增加高亮区域的内边距 */
        border-radius: 0.25rem; /* 轻微圆角 */
        display: inline; /* 确保是行内元素，以便文本换行 */
        /* box-decoration-break 属性用于控制元素在行内断开时的背景、边框、阴影等表现 */
        box-decoration-break: clone; /* 尝试此属性，可能改善多行高亮外观 */
        -webkit-box-decoration-break: clone; /* Webkit前缀 */
    }

    /* 2. <option value="pdf">仅PDF</option>、<option value="step">仅STEP</option>和<option value="both">PDF和STEP</option>三个选项按钮美观一点，不要下拉，要有边框，不要和原背景冲突 */
    .file-type-buttons .btn {
        border-radius: 0.25rem; /* 保持按钮圆角 */
        margin-right: 0.5rem; /* 按钮之间间隔 */
        min-width: 80px; /* 确保按钮宽度一致 */
        /* 针对蓝色背景调整颜色，提高对比度 */
        border-color: white; /* 使用白色作为边框颜色 */
        color: white; /* 使用白色作为文字颜色 */
        background-color: transparent; /* 透明背景 */
        font-weight: 500; /* 略微加粗文字 */
        transition: all 0.2s ease; /* 添加过渡效果 */
    }
    /* 未选中状态的悬浮效果 */
    .file-type-buttons .btn:not(.active):hover {
        background-color: rgba(255, 255, 255, 0.2); /* 白色半透明背景 */
        border-color: white; /* 保持白色边框 */
        color: white; /* 保持白色文字 */
    }
    .file-type-buttons .btn:last-child {
        margin-right: 0; /* 最后一个按钮不需要右边距 */
    }
    /* 为按钮组添加右边距，确保与批量下载按钮的间距 */
    .file-type-buttons {
        margin-right: 1.5rem !important; /* 与批量下载按钮的间距 */
    }
    /* 激活状态的按钮样式 */
    .file-type-buttons .btn.active {
        background-color: white; /* 使用白色作为背景 */
        border-color: white; /* 白色边框 */
        color: var(--bs-primary); /* 主色文字 */
        font-weight: 600; /* 加粗激活状态文字 */
    }
    
    /* 批量下载按钮样式 - 简化设计，确保清晰可见 */
    .batch-download-btn {
        /* 基础样式 */
        padding: 0.25rem 0.75rem; /* 适当的内边距 */
        margin-left: 0 !important; /* 重置左边距，避免与按钮组的右边距冲突 */
        font-size: 0.875rem; /* 字体大小 */
        font-weight: 600; /* 加粗文字 */
        line-height: 1.5; /* 行高 */
        border-radius: 0.25rem; /* 圆角 */
        text-align: center; /* 文字居中 */
        text-decoration: none; /* 无下划线 */
        vertical-align: middle; /* 垂直居中 */
        cursor: pointer; /* 鼠标指针 */
        user-select: none; /* 禁止选中文本 */
        border: 1px solid transparent; /* 边框 */
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; /* 过渡效果 */
        
        /* 自定义颜色 - 确保在蓝色背景上清晰可见 */
        background-color: white; /* 白色背景 */
        color: #0d6efd; /* 蓝色文字 */
        border-color: white; /* 白色边框 */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); /* 轻微阴影 */
    }
    
    /* 批量下载按钮禁用状态 */
    .batch-download-btn:disabled {
        background-color: rgba(255, 255, 255, 0.5); /* 半透明白色背景 */
        color: rgba(0, 0, 0, 0.5); /* 灰色文字 */
        border-color: rgba(255, 255, 255, 0.5); /* 半透明白色边框 */
        box-shadow: none; /* 移除阴影 */
        cursor: not-allowed; /* 禁用光标 */
        opacity: 0.65; /* 降低不透明度 */
    }
    
    /* 批量下载按钮悬浮效果 */
    .batch-download-btn:not(:disabled):hover {
        background-color: #f8f9fa; /* 浅灰色背景 */
        color: #0d6efd; /* 蓝色文字 */
        border-color: white; /* 白色边框 */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* 增强阴影 */
    }

    /* 图片预览样式 */
    .image-preview {
        transition: transform 0.2s ease;
        border: 1px solid #dee2e6;
    }
    
    .image-preview:hover {
        transform: scale(1.05);
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.25);
    }

    /* 图片预览模态框样式 */
    .modal-lg {
        max-width: 90vw;
    }
    
    #previewImage {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* 重置所有th样式，确保表头显示正常 */
    .table th {
        background-color: rgba(0, 123, 255, 0.8) !important;
        color: white !important;
        font-weight: 600 !important;
        padding: 0.75rem !important;
        text-align: center !important;
        border: none !important;
    }
    
    /* 白色模式下未选中的排序列头 - 与普通表头保持一致 */
    .table th.highlight-field {
        background-image: none !important;
        background: none !important;
        background-color: rgba(0, 123, 255, 0.8) !important;
        color: white !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
    
    /* 排序列头悬停效果 */
    .table th.highlight-field:hover {
        background-color: rgba(0, 123, 255, 1) !important;
        color: white !important;
    }
    
    /* 暗色模式下所有表头样式 - 确保颜色一致 */
    [data-bs-theme="dark"] .table th {
        background-image: none !important;
        background: none !important;
        background-color: rgba(0, 123, 255, 0.3) !important;
        color: white !important;
        border: none !important;
        outline: none !important;
        box-shadow: none !important;
    }
    
    /* 暗色模式下排序列头样式 - 与普通表头保持一致 */
    [data-bs-theme="dark"] .table th.highlight-field {
        background-color: rgba(0, 123, 255, 0.3) !important;
    }
    
    /* 暗色模式下排序列头悬停效果 */
    [data-bs-theme="dark"] .table th.highlight-field:hover {
        background-color: rgba(0, 123, 255, 0.5) !important;
        color: white !important;
    }
    
    /* 选中状态下的排序列头样式 */
    .table th.highlight-field,
    .table th.highlight-field a {
        color: white !important;
        font-weight: 600 !important;
    }
    
    /* 排序链接样式 - 确保覆盖整个th区域 */
    .table th.highlight-field a {
        display: block !important;
        width: 100% !important;
        height: 100% !important;
        padding: 0.75rem 0.5rem !important;
        margin: -0.75rem -0.5rem !important;
        text-decoration: none !important;
        color: white !important;
        background: transparent !important;
        text-align: center !important;
    }
    
    /* 排序图标样式 */
    .table th.highlight-field i {
        font-size: 0.85rem !important;
        opacity: 0.8 !important;
        color: white !important;
    }
    
    /* 确保td中的highlight-field样式不受影响 */
    .table td .highlight-field {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .table td .highlight-field:hover {
        background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        transform: scale(1.05);
        border-color: var(--accent-color);
    }
    
    /* 暗色模式下表格内容样式 - 提高可读性 */
    [data-bs-theme="dark"] .table td .highlight-field {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    [data-bs-theme="dark"] .table td .highlight-field:hover {
        background: linear-gradient(135deg, #34495e, #4a637b);
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 搜索结果头部 -->
        <div class="results-header fade-in-up">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-search me-2"></i>
                        搜索结果
                    </h2>
                    <p class="mb-0">共找到 {{ total_results }} 个匹配的产品</p>
                </div>
                <div>
                        <a href="{% if is_style_search %}/style-search/{{ request.session.style_search_unique_id }}/{% else %}{% url 'clamps:search' %}{% endif %}" class="btn btn-light">
                            <i class="bi bi-arrow-left me-2"></i>
                            返回搜索
                        </a>
                    </div>
            </div>
        </div>
        
        {% if page_obj %}
            <!-- 搜索结果表格 -->
            <div class="card fade-in-up">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">搜索结果列表</h5>
                    <div>
                        <div class="input-group">
                            <!-- 替换下拉框为按钮组 -->
                            <div class="btn-group file-type-buttons" role="group" aria-label="文件类型选择">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-file-type="pdf">仅PDF</button>
                                <button type="button" class="btn btn-outline-primary btn-sm active" data-file-type="step">仅STEP</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-file-type="both">PDF和STEP</button>
                            </div>
                            <button id="batchDownloadBtn" class="batch-download-btn" disabled>
                                <i class="bi bi-download me-2"></i>批量下载选中项
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th width="5%"><input type="checkbox" id="selectAll"></th>
                                    <th width="5%">序号</th>
							<!--
                                    <th width="20%" class="highlight-field">描述</th>
							-->
                                    <th width="15%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=drawing_no_1&sort_dir={% if sort_by == 'drawing_no_1' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            图号1(o)
                                            {% if sort_by == 'drawing_no_1' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=throat_depth&sort_dir={% if sort_by == 'throat_depth' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            喉深
                                            {% if sort_by == 'throat_depth' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=throat_width&sort_dir={% if sort_by == 'throat_width' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            喉宽
                                            {% if sort_by == 'throat_width' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=transformer&sort_dir={% if sort_by == 'transformer' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            变压器
                                            {% if sort_by == 'transformer' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="12%" class="highlight-field">
                                        <a href="?{% for key, value in query_params.items %}{% if key != 'sort_by' and key != 'sort_dir' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}sort_by=clamping_force&sort_dir={% if sort_by == 'clamping_force' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none text-reset">
                                            加压力
                                            {% if sort_by == 'clamping_force' %}
                                                {% if sort_dir == 'asc' %}<i class="bi bi-arrow-up ms-1"></i>{% else %}<i class="bi bi-arrow-down ms-1"></i>{% endif %}
                                            {% endif %}
                                        </a>
                                    </th>
                                    <th width="15%">预览图</th>
                                    <th width="12%">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in page_obj %}
                                    <tr class="product-row" data-product-id="{{ product.id }}">
                                        <td><input type="checkbox" class="product-checkbox" value="{{ product.id }}"></td>
                                        <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
										<!--
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.description|default:"--" }}
                                            </span>
                                        </td>
										-->
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.drawing_no_1|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.throat_depth %}
                                                    {{ product.throat_depth }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.throat_width %}
                                                    {{ product.throat_width }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.transformer|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.clamping_force %}
                                                    {{ product.clamping_force }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            {% if product.bmp_file_path %}
                                             <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZGVlMmU2Ii8+PHRleHQgeD0iMzAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkrDqMO85a+85aSnPC90ZXh0Pjwvc3ZnPg==" 
                                                     data-src="{% url 'clamps:protected_media' path=product.bmp_file_path %}" 
                                                     class="image-preview lazyload" 
                                                onclick="previewImage('{% url 'clamps:protected_media' path=product.bmp_file_path %}', '{{ product.drawing_no_1|default:"未知产品" }}')"                                      alt="产品预览图"
                                                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 4px;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                                     title="点击图片放大查看">
                                                <span class="text-muted" style="display: none;">无图片</span>
                                            {% else %}
                                                <span class="text-muted">无图片</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <a href="{% url 'clamps:product_detail' product.id %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-eye me-1"></i>详情
                                                </a>
                                                {% if product.pdf_file_path %}
                                                    <button onclick="downloadSingleFile({{ product.id }}, 'pdf', '{{ product.drawing_no_1|escapejs }}')" 
                                                       class="btn btn-outline-success btn-sm download-btn">
                                                        <i class="bi bi-download me-1"></i>PDF
                                                    </button>
                                                {% endif %}

                                                {% if product.step_file_path %}
                                                    <button onclick="downloadSingleFile({{ product.id }}, 'step', '{{ product.drawing_no_1|escapejs }}')" 
                                                       class="btn btn-outline-info btn-sm download-btn">
                                                        <i class="bi bi-download me-1"></i>STEP
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 分页导航 -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="搜索结果分页" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page=1">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.previous_page_number }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.next_page_number }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <div class="text-center text-muted">
                    第 {{ page_obj.number }} 页，共 {{ page_obj.paginator.num_pages }} 页
                    (显示第 {{ page_obj.start_index }} - {{ page_obj.end_index }} 条记录，共 {{ total_results }} 条)
                </div>
            {% endif %}
            
        {% else %}
            <!-- 无搜索结果 -->
            <div class="text-center py-5 fade-in-up">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-muted">未找到匹配的产品</h3>
                        <p class="text-muted">请尝试调整搜索条件或使用不同的关键词</p>
                        <a href="{% if is_style_search %}/style-search/{{ request.session.style_search_unique_id }}/{% else %}{% url 'clamps:search' %}{% endif %}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-2"></i>
                            重新搜索
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- 搜索条件摘要 -->
        {% if query_params %}
            <div class="card mt-4 fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        当前搜索条件
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for key, value in query_params.items %}
                            {% if value %}
                                <div class="col-md-3 mb-2">
                                    <span class="badge bg-primary">
                                        {{ key }}: {{ value }}
                                    </span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- 图片预览模态框 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">
                    <i class="bi bi-image me-2"></i>
                    产品预览图
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="previewImage" src="" alt="产品预览图" class="img-fluid" >
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/compression_async.js' %}"></script>
<script>
    // Lazy loading implementation
    document.addEventListener("DOMContentLoaded", function() {
        // Intersection Observer for lazy loading
        const lazyLoadImages = document.querySelectorAll(".lazyload");
        
        if ("IntersectionObserver" in window) {
            let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        let lazyImage = entry.target;
                        lazyImage.src = lazyImage.dataset.src;
                        lazyImage.classList.remove("lazyload");
                        lazyImageObserver.unobserve(lazyImage);
                    }
                });
            });
            
            lazyLoadImages.forEach(function(lazyImage) {
                lazyImageObserver.observe(lazyImage);
            });
        } else {
            // Fallback for browsers that don't support Intersection Observer
            let lazyLoadThrottleTimeout;
            
            function lazyLoad() {
                if (lazyLoadThrottleTimeout) {
                    clearTimeout(lazyLoadThrottleTimeout);
                }
                
                lazyLoadThrottleTimeout = setTimeout(function() {
                    const scrollTop = window.pageYOffset;
                    
                    lazyLoadImages.forEach(function(img) {
                        if (img.offsetTop < (window.innerHeight + scrollTop)) {
                            img.src = img.dataset.src;
                            img.classList.remove("lazyload");
                        }
                    });
                    
                    if (lazyLoadImages.length === 0) {
                        document.removeEventListener("scroll", lazyLoad);
                        window.removeEventListener("resize", lazyLoad);
                        window.removeEventListener("orientationChange", lazyLoad);
                    }
                }, 20);
            }
            
            document.addEventListener("scroll", lazyLoad);
            window.addEventListener("resize", lazyLoad);
            window.addEventListener("orientationChange", lazyLoad);
        }
    });
    
    function viewDetail(productId) {
        window.location.href = `/product/${productId}/`;
    }
    
    // 图片预览功能 - 增强版，与product_detail.html保持一致
    function previewImage(imageSrc, productName) {
        const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
        const previewImg = document.getElementById('previewImage');
        const modalTitle = document.getElementById('imagePreviewModalLabel');
        
        // 设置图片源和标题
        previewImg.src = imageSrc;
        modalTitle.innerHTML = `<i class="bi bi-image me-2"></i>产品预览图 - ${productName || '未知产品'}`;
        
        // 显示模态框
        modal.show();
        
        // 图片加载错误处理
        previewImg.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGVlMmU2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjNmM3NTdkIj7ml6Dms5Xmn6XnnIvlm77niYc8L3RleHQ+PC9zdmc+';
            modalTitle.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>图片加载失败 - ${productName || '未知产品'}`;
        };
    }
    
    // 全选/取消全选功能
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBatchDownloadButton();
    });
    
    // 监听单个复选框变化
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchDownloadButton);
    });
    
    // 更新批量下载按钮状态
    function updateBatchDownloadButton() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        const batchDownloadBtn = document.getElementById('batchDownloadBtn');
        
        if (checkedBoxes.length > 0) {
            batchDownloadBtn.disabled = false;
            batchDownloadBtn.innerHTML = `<i class="bi bi-download me-2"></i>批量下载选中项 (${checkedBoxes.length})`;
        } else {
            batchDownloadBtn.disabled = true;
            batchDownloadBtn.innerHTML = '<i class="bi bi-download me-2"></i>批量下载选中项';
        }
    }
    
    // 文件类型按钮切换
    document.querySelectorAll('.file-type-buttons .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // 移除所有按钮的active类
            document.querySelectorAll('.file-type-buttons .btn').forEach(b => b.classList.remove('active'));
            // 为当前按钮添加active类
            this.classList.add('active');
        });
    });
    
    // 批量下载功能 - 异步压缩优化
    document.getElementById('batchDownloadBtn').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        if (checkedBoxes.length === 0) {
            showToast('请先选择要下载的产品', 'warning');
            return;
        }
        
        const productIds = Array.from(checkedBoxes).map(cb => cb.value);
        const activeFileType = document.querySelector('.file-type-buttons .btn.active').dataset.fileType;
        let isDownloadReady = false;
        
        // 先检查文件大小和存在性 - 完全依赖后端检查
        checkBatchFileSize(productIds, activeFileType, () => {
            // 检查通过，开始压缩并显示下载提示
            startCompression(productIds, activeFileType, (taskId) => {
                // 显示带有进度的下载提示
                showDownloadWarning(() => {
                    // 只有当压缩完成时才允许下载
                    if (isDownloadReady) {
                        // 下载完成的文件
                        downloadCompressedFile(taskId, activeFileType);
                    } else {
                        // 如果还没准备好，显示提示
                        showToast('压缩任务尚未完成，请稍候再试', 'warning');
                    }
                }, taskId);
                
                // 开始检查进度
                let progressCheckInterval = setInterval(() => {
                    checkCompressionProgress(taskId, (progress, isCompleted) => {
                        updateCompressionProgress(progress);
                        
                        // 更新下载按钮状态
                        const directDownloadBtn = document.getElementById('directDownloadBtn');
                        if (directDownloadBtn) {
                            if (isCompleted) {
                                directDownloadBtn.disabled = false;
                                directDownloadBtn.innerHTML = '<i class="bi bi-download me-1"></i>开始下载';
                                isDownloadReady = true;
                                // 压缩完成，自动开始下载
                                clearInterval(progressCheckInterval);
                                setTimeout(() => {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('downloadWarningModal'));
                                    if (modal) {
                                        modal.hide();
                                        downloadCompressedFile(taskId, activeFileType);
                                    }
                                }, 1000);
                            } else {
                                directDownloadBtn.disabled = true;
                                directDownloadBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>压缩中...(' + progress + '%)';
                            }
                        }
                    });
                }, 1000);
            });
        });
    });
    
    // 从cookie获取CSRF令牌
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // 此cookie字符串是否以我们想要的名称开头？
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    window.CSRF_TOKEN = csrftoken;
    
    // 单个文件下载 - 异步压缩优化
    function downloadSingleFile(productId, fileType, productName) {
        // 检查文件大小和存在性
        checkBatchFileSize([productId], fileType, () => {
            // 检查通过，开始压缩并显示下载提示
            startCompression([productId], fileType, (taskId) => {
                let isDownloadReady = false;
                let requestFileType = fileType; // 保存当前请求的文件类型
                
                // 显示带有进度的下载提示
                showDownloadWarning(() => {
                    // 只有当压缩完成时才允许下载
                    if (isDownloadReady) {
                        // 下载完成的文件
                        downloadCompressedFile(taskId, requestFileType);
                    } else {
                        // 如果还没准备好，显示提示
                        showToast('压缩任务尚未完成，请稍候再试', 'warning');
                    }
                }, taskId);
                
                // 开始检查进度
                let progressCheckInterval = setInterval(() => {
                    checkCompressionProgress(taskId, (progress, isCompleted) => {
                        updateCompressionProgress(progress);
                        
                        // 更新下载按钮状态
                        const directDownloadBtn = document.getElementById('directDownloadBtn');
                        if (directDownloadBtn) {
                            if (isCompleted) {
                                directDownloadBtn.disabled = false;
                                directDownloadBtn.innerHTML = '<i class="bi bi-download me-1"></i>开始下载';
                                isDownloadReady = true;
                                // 压缩完成，自动开始下载
                                clearInterval(progressCheckInterval);
                                setTimeout(() => {
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('downloadWarningModal'));
                                    if (modal) {
                                        modal.hide();
                                        downloadCompressedFile(taskId, requestFileType);
                                    }
                                }, 1000);
                            } else {
                                directDownloadBtn.disabled = true;
                                directDownloadBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>压缩中...(' + progress + '%)';
                            }
                        }
                    });
                }, 1000);
            });
        });
    }
    
    // 检查单个文件大小
    function checkFileSize(productId, fileType, callback) {
        // 添加语言参数
        const language = window.location.pathname.includes('en') || window.location.pathname.includes('_en') ? 'en' : 'zh';
        fetch(`{% url 'clamps:check_file_size' 0 'TYPE' %}`.replace('0', productId).replace('TYPE', fileType) + `?language=${language}`)
            .then(response => response.json())
            .then(data => {
                if (data.can_download) {
                    callback();
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('检查文件大小时出错:', error);
                showToast('检查文件大小时出错，请稍后重试', 'danger');
            });
    }
    
    // 检查批量下载文件大小 - 修复为使用POST请求
    function checkBatchFileSize(productIds, fileType, callback) {
        // 使用JSON格式发送请求，配合CSRF header
        const requestData = {
            product_ids: productIds.join(','),
            file_type: fileType,
            language: window.location.pathname.includes('en') || window.location.pathname.includes('_en') ? 'en' : 'zh'
        };
        
        fetch('{% url "clamps:check_batch_file_size" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.CSRF_TOKEN
            },
            body: JSON.stringify(requestData),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.can_download) {
                callback();
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('检查批量文件大小时出错:', error);
            showToast('检查文件大小时出错，请稍后重试', 'danger');
        });
    }
    
    function showDownloadWarning(callback, taskId = null) {
        const warningHtml = `
            <div class="modal fade" id="downloadWarningModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-download me-2"></i>
                                下载提示
                            </h5>
                        </div>
                        <div class="modal-body">
                            <div class="alert" style="background-color: #e0f7fa; border: 1px solid #b2ebf2; border-radius: 8px; color: #2c3e50; padding: 12px 16px;">
                                <i class="bi bi-info-circle me-2" style="color: #2c3e50;"></i>
                                图纸模型数据由于各种原因发生变更后不另行通知，选型数据库无法保证图纸模型数据完全正确，该数据不作为任何参考依据。
                            </div>
                            <div class="text-center">
                                <div class="spinner-border text-primary me-2" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <span>正在准备文件，请稍候...</span><br>数据较多时服务器压缩需要时间，请耐心等待
                            </div>
                            ${taskId ? `
                            <div class="mt-3">
                                <h6>压缩进度:</h6>
                                <div class="progress">
                                    <div id="compressionProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="directDownloadBtn" disabled>
                                <i class="bi bi-hourglass-split me-1"></i>
                                压缩中...
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除已存在的模态框
        const existingModal = document.getElementById('downloadWarningModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', warningHtml);
        const modal = new bootstrap.Modal(document.getElementById('downloadWarningModal'));
        
        const directDownloadBtn = document.getElementById('directDownloadBtn');
        
        directDownloadBtn.addEventListener('click', () => {
            modal.hide();
            callback();
        });
        
        modal.show();
        
        // 模态框关闭时清理
        document.getElementById('downloadWarningModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('downloadWarningModal').remove();
        });
    }
    
    // Update compression progress in the modal
    function updateCompressionProgress(progress) {
        const progressElement = document.getElementById('compressionProgress');
        if (progressElement) {
            progressElement.style.width = `${progress}%`;
            progressElement.textContent = `${progress}%`;
            progressElement.setAttribute('aria-valuenow', progress);
        }
    }
    
    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="alert alert-dismissible show" role="alert" style="background-color: #e0f7fa; border: 1px solid #b2ebf2; border-radius: 8px; color: #dc3545; padding: 12px 16px; margin-bottom: 16px; z-index: 9999; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 600px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center;">
                <i class="bi bi-exclamation-circle me-2" style="color: #dc3545;"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" style="color: #dc3545; opacity: 0.7; margin-left: auto;"></button>
            </div>
        `;
        
        // 插入到body末尾，使用固定定位使其居中显示
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        
        // 自动清理alert元素
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert.show');
            if (alerts.length > 0) {
                alerts[alerts.length - 1].remove();
            }
        }, 5000);
    }
</script>

<!-- 添加CSRF token到页面中供JavaScript使用 -->
{% csrf_token %}
{% endblock %}

