<!--
  Copyright [2025] [OBARA (Nanjing) Electromechanical Co., Ltd]

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->


{% extends 'base.html' %}

{% block title %}日志管理 - 小原焊枪选型数据库{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4 fade-in-up">
            <h1 class="display-6 fw-bold">
                <i class="bi bi-clock-history me-2"></i>
                操作日志管理
            </h1>
            <div>
                <a href="{% url 'clamps:management_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    返回仪表板
                </a>
            </div>
        </div>
        
        <!-- 下载数据可视化卡片 -->
        <div class="card mb-4 fade-in-up">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>
                    下载数据可视化
                </h5>
            </div>
            <div class="card-body">
                <!-- 时间范围选择器 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="timeRange" class="form-label">时间范围</label>
                        <select class="form-select" id="timeRange" onchange="updateDownloadChart()">
                            <option value="7">最近7天</option>
                            <option value="30">最近一个月</option>
                            <option value="90">最近三个月</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="userFilter" class="form-label">用户筛选</label>
                        <select class="form-select" id="userFilter" onchange="updateDownloadChart()">
                            <option value="all">全部用户</option>
                            <!-- 用户选项将通过JavaScript动态填充 -->
                        </select>
                    </div>
                </div>
                
                <!-- 统计卡片 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <i class="bi bi-download text-primary" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalDownloads">0</h4>
                                <p class="text-muted mb-0">总下载次数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <i class="bi bi-file-earmark text-success" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalFiles">0</h4>
                                <p class="text-muted mb-0">总文件数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <i class="bi bi-hdd text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalSize">0 MB</h4>
                                <p class="text-muted mb-0">总下载大小</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <i class="bi bi-people text-info" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="activeUsers">0</h4>
                                <p class="text-muted mb-0">活跃用户数</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 图表容器 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">下载趋势图</h6>
                            </div>
                            <div class="card-body" id="trendChartContainer">
                                <canvas id="downloadTrendChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card" style="height: 100%;">
                            <div class="card-header">
                                <h6 class="mb-0">用户下载分布</h6>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center" id="distributionChartContainer" style="min-height: 200px;">
                                <canvas id="userDistributionChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 详细数据表格 -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <!-- 用户信息侧边栏 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">用户统计信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">活跃用户</span>
                                        <span class="badge bg-primary" id="sidebarActiveUsers">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">平均下载量</span>
                                        <span class="badge bg-info" id="avgDownloads">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">最高下载用户</span>
                                        <span class="badge bg-success" id="topUser">-</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">平均文件大小</span>
                                        <span class="badge bg-warning" id="avgFileSize">0 MB</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <small class="text-muted">数据更新时间</small>
                                    <div id="lastUpdateTime" class="fw-bold">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">详细下载数据</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="downloadDetailsTable">
                                        <thead>
                                            <tr>
                                                <th>用户名</th>
                                                <th>下载次数</th>
                                                <th>文件数量</th>
                                                <th>总大小 (MB)</th>
                                                <th>平均文件大小 (MB)</th>
                                                <th>最后下载时间</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadDetailsBody">
                                            <!-- 数据将通过JavaScript动态填充 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 筛选器 -->
        <div class="card mb-4 fade-in-up">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>
                    日志筛选
                </h5>
            </div>
            <div class="card-body">
                <form method="get" action="{% url 'clamps:view_logs' %}" class="row g-3">
                    <div class="col-md-3">
                        <label for="action_type" class="form-label">操作类型</label>
                        <select class="form-select" id="action_type" name="action_type">
                            <option value="">全部</option>
                            <option value="login" {% if request.GET.action_type == 'login' %}selected{% endif %}>登录</option>
                            <option value="search" {% if request.GET.action_type == 'search' %}selected{% endif %}>搜索</option>
                            <option value="download" {% if request.GET.action_type == 'download' or request.GET.action_type == 'batch_download' %}selected{% endif %}>下载</option>
                            <option value="view" {% if request.GET.action_type == 'view' %}selected{% endif %}>查看</option>
                            <option value="export_data" {% if request.GET.action_type == 'export_data' %}selected{% endif %}>导出数据</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="username" name="username" 
                               value="{{ request.GET.username }}" placeholder="输入用户名">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="date_from" class="form-label">开始日期</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ request.GET.date_from }}">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="date_to" class="form-label">结束日期</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ request.GET.date_to }}">
                    </div>
                    
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-2"></i>
                            筛选日志
                        </button>
                        <a href="{% url 'clamps:view_logs' %}" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            重置筛选
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 日志列表 -->
        <div class="card fade-in-up">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list me-2"></i>
                    操作日志 (共 {{ total_count }} 条)
                </h5>
                <div>
                    <form method="post" action="{% url 'clamps:export_data' %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="data_type" value="logs">
                        <!-- 保持当前筛选条件 -->
                        {% if request.GET.action_type %}
                            <input type="hidden" name="action_type" value="{{ request.GET.action_type }}">
                        {% endif %}
                        {% if request.GET.username %}
                            <input type="hidden" name="username" value="{{ request.GET.username }}">
                        {% endif %}
                        {% if request.GET.date_from %}
                            <input type="hidden" name="date_from" value="{{ request.GET.date_from }}">
                        {% endif %}
                        {% if request.GET.date_to %}
                            <input type="hidden" name="date_to" value="{{ request.GET.date_to }}">
                        {% endif %}
                        <button type="submit" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download me-2"></i>
                            导出日志
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body p-0">
                {% if page_obj %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th width="15%">时间</th>
                                    <th width="12%">用户</th>
                                    <th width="10%">操作类型</th>
                                    <th width="35%">详情</th>
                                    <th width="12%">IP地址</th>
                                    <th width="16%">用户代理</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in page_obj %}
                                    <tr>
                                        <td>
                                            <small>{{ log.timestamp|date:"Y-m-d H:i:s" }}</small>
                                        </td>
                                        <td>
                                            {% if log.user %}
                                                <span class="badge bg-primary">{{ log.user.username }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">匿名</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if log.action_type == 'login' %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-box-arrow-in-right me-1"></i>
                                                    登录
                                                </span>
                                            {% elif log.action_type == 'search' %}
                                                <span class="badge bg-info">
                                                    <i class="bi bi-search me-1"></i>
                                                    搜索
                                                </span>
                                            {% elif log.action_type == 'download' or log.action_type == 'batch_download' %}
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-download me-1"></i>
                                                    下载
                                                </span>
                                            {% elif log.action_type == 'view' %}
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-eye me-1"></i>
                                                    查看
                                                </span>
                                            {% elif log.action_type == 'export_data' %}
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-file-earmark-arrow-down me-1"></i>
                                                    导出
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ log.action_type }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ log.details|truncatechars:80 }}
                                                {% if log.details|length > 80 %}
                                                    <a href="#" onclick="showFullDetails('{{ log.id }}', '{{ log.details|escapejs }}')" class="text-primary">
                                                        查看全部
                                                    </a>
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ log.ip_address|default:"--" }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ log.user_agent|truncatechars:30|default:"--" }}
                                            </small>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页导航 -->
                    {% if page_obj.has_other_pages %}
                        <nav aria-label="日志分页" class="mt-3">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        
                        <div class="text-center text-muted">
                            第 {{ page_obj.number }} 页，共 {{ page_obj.paginator.num_pages }} 页
                            (显示第 {{ page_obj.start_index }} - {{ page_obj.end_index }} 条记录，共 {{ total_count }} 条)
                        </div>
                    {% endif %}
                    
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-muted">暂无日志记录</h3>
                        <p class="text-muted">没有找到符合条件的操作日志</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- 日志统计 -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center fade-in-up">
                    <div class="card-body">
                        <i class="bi bi-box-arrow-in-right text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2">{{ login_count }}</h4>
                        <p class="text-muted mb-0">登录次数</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center fade-in-up">
                    <div class="card-body">
                        <i class="bi bi-search text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2">{{ search_count }}</h4>
                        <p class="text-muted mb-0">搜索次数</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center fade-in-up">
                    <div class="card-body">
                        <i class="bi bi-download text-warning" style="font-size: 2rem;"></i>
                        <h4 class="mt-2">{{ download_count }}</h4>
                        <p class="text-muted mb-0">下载次数</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center fade-in-up">
                    <div class="card-body">
                        <i class="bi bi-eye text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2">{{ view_count }}</h4>
                        <p class="text-muted mb-0">查看次数</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详情模态框 -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">操作详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailsContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% load static %}

{% block extra_js %}
<!-- Chart.js 库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 全局变量
    let downloadTrendChart = null;
    let userDistributionChart = null;
    let downloadData = {};
    
    // 模拟数据生成函数
    function generateMockData(days, user = 'all') {
        const mockUsers = ['admin', 'user1', 'user2', 'user3', 'user4'];
        const today = new Date();
        
        // 生成趋势数据
        const trendData = [];
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            trendData.push({
                date: date.toISOString().split('T')[0],
                downloads: Math.floor(Math.random() * 50) + 10,
                size: Math.floor(Math.random() * 100) + 20
            });
        }
        
        // 生成用户下载数据
        const downloads = {};
        const filteredUsers = user === 'all' ? mockUsers : [user];
        
        filteredUsers.forEach(username => {
            const count = Math.floor(Math.random() * 100) + 10;
            const files = Math.floor(Math.random() * 50) + 5;
            const size = Math.floor(Math.random() * 500) + 50;
            
            downloads[username] = {
                count: count,
                files: files,
                size: size,
                lastDownload: new Date(today.getTime() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleString()
            };
        });
        
        // 计算汇总数据
        const summary = {
            totalDownloads: Object.values(downloads).reduce((sum, user) => sum + user.count, 0),
            totalFiles: Object.values(downloads).reduce((sum, user) => sum + user.files, 0),
            totalSize: Object.values(downloads).reduce((sum, user) => sum + user.size, 0),
            activeUsers: Object.keys(downloads).length
        };
        
        return {
            trend: trendData,
            downloads: downloads,
            summary: summary,
            users: mockUsers
        };
    }
    
    // 从API获取下载数据（使用模拟数据）
    async function fetchDownloadData(days, user = 'all') {
        try {
            // 模拟网络延迟
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 返回模拟数据
            return generateMockData(parseInt(days), user);
        } catch (error) {
            console.error('获取下载数据失败:', error);
            showToast('获取下载数据失败，请稍后重试', 'danger');
            return null;
        }
    }
    
    // 显示加载状态
    function showLoading() {
        const loadingHtml = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div><p class="mt-2">正在加载图表数据...</p></div>';
        
        const trendContainer = document.getElementById('trendChartContainer');
        const distributionContainer = document.getElementById('distributionChartContainer');
        
        if (trendContainer) {
            trendContainer.innerHTML = loadingHtml;
        }
        if (distributionContainer) {
            distributionContainer.innerHTML = loadingHtml;
        }
    }
    
    // 隐藏加载状态
    function hideLoading() {
        // 重新创建canvas元素
        const trendContainer = document.getElementById('trendChartContainer');
        const distributionContainer = document.getElementById('distributionChartContainer');
        
        if (trendContainer) {
            trendContainer.innerHTML = '<canvas id="downloadTrendChart" width="400" height="200"></canvas>';
        }
        if (distributionContainer) {
            distributionContainer.innerHTML = '<canvas id="userDistributionChart" width="300" height="200"></canvas>';
        }
    }
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成，开始初始化...');
        
        // 延迟初始化以确保所有资源加载完成
        setTimeout(() => {
            initializeUserFilter();
            updateDownloadChart();
        }, 500);
    });
    
    // 初始化用户筛选器
    async function initializeUserFilter() {
        const userFilter = document.getElementById('userFilter');
        const timeRange = document.getElementById('timeRange').value;
        
        // 获取数据
        const data = await fetchDownloadData(timeRange);
        if (!data) return;
        
        const users = data.users || [];
        
        // 清空现有选项（保留"全部用户"）
        userFilter.innerHTML = '<option value="all">全部用户</option>';
        
        // 添加用户选项
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            userFilter.appendChild(option);
        });
    }
    
    // 更新下载图表
    async function updateDownloadChart() {
        const timeRange = document.getElementById('timeRange').value;
        const userFilter = document.getElementById('userFilter').value;
        
        // 显示加载状态
        showLoading();
        
        try {
            // 更新用户筛选器
            if (userFilter === 'all') {
                await initializeUserFilter();
            }
            
            // 获取数据
            const data = await fetchDownloadData(timeRange, userFilter);
            if (!data) return;
            
            downloadData = data;
            
            // 隐藏加载状态
            hideLoading();
            
            // 等待DOM更新
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // 更新统计卡片
            updateStatistics(data);
            
            // 更新图表
            updateTrendChart(data.trend);
            updateDistributionChart(data, userFilter);
            
            // 更新详细数据表格
            updateDetailsTable(data, userFilter);
        } catch (error) {
            console.error('更新图表失败:', error);
            hideLoading();
        }
    }
    
    // 更新统计卡片
    function updateStatistics(data) {
        const summary = data.summary || {};
        const downloads = data.downloads || {};
        
        document.getElementById('totalDownloads').textContent = summary.totalDownloads || 0;
        document.getElementById('totalFiles').textContent = summary.totalFiles || 0;
        document.getElementById('totalSize').textContent = (summary.totalSize || 0).toFixed(1) + ' MB';
        document.getElementById('activeUsers').textContent = summary.activeUsers || 0;
        
        // 更新侧边栏用户信息
        updateSidebarInfo(data);
    }
    
    // 更新侧边栏用户信息
    function updateSidebarInfo(data) {
        const summary = data.summary || {};
        const downloads = data.downloads || {};
        
        // 活跃用户数
        document.getElementById('sidebarActiveUsers').textContent = summary.activeUsers || 0;
        
        // 计算平均下载量
        const totalUsers = Object.keys(downloads).length;
        const avgDownloads = totalUsers > 0 ? Math.round((summary.totalDownloads || 0) / totalUsers) : 0;
        document.getElementById('avgDownloads').textContent = avgDownloads;
        
        // 找出最高下载用户
        let topUser = '-';
        let maxDownloads = 0;
        Object.keys(downloads).forEach(username => {
            if (downloads[username].count > maxDownloads) {
                maxDownloads = downloads[username].count;
                topUser = username;
            }
        });
        document.getElementById('topUser').textContent = topUser;
        
        // 计算平均文件大小
        const avgFileSize = (summary.totalFiles || 0) > 0 ? 
            ((summary.totalSize || 0) / (summary.totalFiles || 0)).toFixed(2) : '0.00';
        document.getElementById('avgFileSize').textContent = avgFileSize + ' MB';
        
        // 更新时间
        const now = new Date();
        const timeString = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('lastUpdateTime').textContent = timeString;
    }
    
    // 更新趋势图表
    function updateTrendChart(trendData) {
        const canvas = document.getElementById('downloadTrendChart');
        if (!canvas) {
            console.error('找不到趋势图canvas元素');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        if (downloadTrendChart) {
            downloadTrendChart.destroy();
        }
        
        downloadTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.map(item => item.date),
                datasets: [{
                    label: '下载次数',
                    data: trendData.map(item => item.downloads),
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: '下载大小 (MB)',
                    data: trendData.map(item => item.size),
                    borderColor: '#ff6b35',
                    backgroundColor: 'rgba(255, 107, 53, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '日期'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '下载次数'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '下载大小 (MB)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });
    }
    
    // 更新分布图表
    function updateDistributionChart(data, userFilter) {
        const canvas = document.getElementById('userDistributionChart');
        if (!canvas) {
            console.error('找不到分布图canvas元素');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        if (userDistributionChart) {
            userDistributionChart.destroy();
        }
        
        let chartData, labels;
        const downloads = data.downloads || {};
        
        if (userFilter === 'all') {
            labels = Object.keys(downloads);
            chartData = Object.values(downloads).map(user => user.count);
        } else {
            const user = downloads[userFilter];
            if (user) {
                labels = ['下载次数', '文件数量'];
                chartData = [user.count, user.files];
            } else {
                labels = [];
                chartData = [];
            }
        }
        
        const colors = [
            '#0066cc', '#ff6b35', '#28a745', '#ffc107', 
            '#dc3545', '#6f42c1', '#20c997', '#fd7e14'
        ];
        
        userDistributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: chartData,
                    backgroundColor: colors.slice(0, chartData.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 更新详细数据表格
    function updateDetailsTable(data, userFilter) {
        const tbody = document.getElementById('downloadDetailsBody');
        tbody.innerHTML = '';
        
        const downloads = data.downloads || {};
        let users;
        
        if (userFilter === 'all') {
            users = Object.keys(downloads);
        } else {
            users = downloads[userFilter] ? [userFilter] : [];
        }
        
        users.forEach(username => {
            const user = downloads[username];
            const avgSize = user.files > 0 ? (user.size / user.files).toFixed(2) : '0.00';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-primary">${username}</span></td>
                <td>${user.count}</td>
                <td>${user.files}</td>
                <td>${user.size.toFixed(1)}</td>
                <td>${avgSize}</td>
                <td><small class="text-muted">${user.lastDownload}</small></td>
            `;
            tbody.appendChild(row);
        });
        
        if (users.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" class="text-center text-muted">暂无数据</td>';
            tbody.appendChild(row);
        }
    }
    
    // 原有的日志相关功能
    function showFullDetails(logId, details) {
        document.getElementById('detailsContent').innerHTML = '<p><strong>日志ID:</strong> ' + logId + '</p><p><strong>详细信息:</strong></p><pre>' + details + '</pre>';
        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        modal.show();
    }
    
    // 设置日期筛选的默认值
    document.addEventListener('DOMContentLoaded', function() {
        const dateToInput = document.getElementById('date_to');
        if (!dateToInput.value) {
            const today = new Date().toISOString().split('T')[0];
            dateToInput.value = today;
        }
        
        const dateFromInput = document.getElementById('date_from');
        if (!dateFromInput.value) {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            dateFromInput.value = weekAgo.toISOString().split('T')[0];
        }
    });
    
    // 导出按钮点击事件
    document.querySelector('form[action*="export_data"] button[type="submit"]').addEventListener('click', function(e) {
        showToast('正在导出日志数据，请稍候...', 'info');
    });
    
    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toast = new bootstrap.Toast(toastContainer.lastElementChild);
        toast.show();
    }
</script>
{% endblock %}
