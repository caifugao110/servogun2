<!--
  Copyright [2025] [OBARA (Nanjing) Electromechanical Co., Ltd]

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

{% extends 'base.html' %}

{% block title %}鏁版嵁鍒嗘瀽 - 灏忓師鐒婃灙閫夊瀷鏁版嵁搴搟% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4 fade-in-up">
            <h1 class="display-6 fw-bold">
                <i class="bi bi-bar-chart me-2"></i>
                鏁版嵁鍒嗘瀽涓績
            </h1>
            <div>
                <a href="{% url 'clamps:management_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    杩斿洖浠〃鏉?
                </a>
            </div>
        </div>
        
        <!-- 涓嬭浇鏁版嵁鍙鍖栧崱鐗?-->
        <div class="card mb-4 fade-in-up">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>
                    涓嬭浇鏁版嵁鍙鍖?
                </h5>
            </div>
            <div class="card-body">
                <!-- 鏃堕棿鑼冨洿閫夋嫨鍣?-->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="timeRange" class="form-label">鏃堕棿鑼冨洿</label>
                        <select class="form-select" id="timeRange" onchange="updateDownloadChart()">
                            <option value="1">浠婂ぉ</option>
                            <option value="3">鏈€杩戜笁澶?/option>
                            <option value="7">鏈€杩戜竴鍛?/option>
							<option value="15">鏈€杩戝崐鏈?/option>
							<option value="30">鏈€杩戜竴鏈?/option>
							<option value="60">鏈€杩戜袱鏈?/option>
							<option value="90">鏈€杩戜笁鏈?/option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="userFilter" class="form-label">鐢ㄦ埛绛涢€?/label>
                        <select class="form-select" id="userFilter" onchange="updateDownloadChart()">
                            <option value="all">鍏ㄩ儴鐢ㄦ埛</option>
                            <!-- 鐢ㄦ埛閫夐」灏嗛€氳繃JavaScript鍔ㄦ€佸～鍏?-->
                        </select>
                    </div>
                </div>
                
                <!-- 缁熻鍗＄墖 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center card-stats">
                            <div class="card-body">
                                <i class="bi bi-download text-primary" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalDownloads">-</h4>
                                <p class="text-muted mb-0">鎬讳笅杞芥鏁?/p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center card-stats">
                            <div class="card-body">
                                <i class="bi bi-file-earmark text-success" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalFiles">-</h4>
                                <p class="text-muted mb-0">鎬绘枃浠舵暟</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center card-stats">
                            <div class="card-body">
                                <i class="bi bi-hdd text-warning" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="totalSize">-</h4>
                                <p class="text-muted mb-0">鎬讳笅杞藉ぇ灏?/p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center card-stats">
                            <div class="card-body">
                                <i class="bi bi-people text-info" style="font-size: 2rem;"></i>
                                <h4 class="mt-2" id="activeUsers">-</h4>
                                <p class="text-muted mb-0">娲昏穬鐢ㄦ埛鏁?/p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 鍥捐〃瀹瑰櫒 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">涓嬭浇瓒嬪娍鍥?/h6>
                            </div>
                            <div class="card-body" id="trendChartContainer">
                                <div class="text-center text-muted p-4">
                                    <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
                                    <p class="mt-2">绛夊緟鏁版嵁鍔犺浇...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card" style="height: 100%;">
                            <div class="card-header">
                                <h6 class="mb-0">鐢ㄦ埛涓嬭浇鍒嗗竷</h6>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center" id="distributionChartContainer" style="min-height: 200px;">
                                <div class="text-center text-muted">
                                    <i class="bi bi-pie-chart" style="font-size: 3rem;"></i>
                                    <p class="mt-2">绛夊緟鏁版嵁鍔犺浇...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 璇︾粏鏁版嵁琛ㄦ牸 -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <!-- 鐢ㄦ埛淇℃伅渚ц竟鏍?-->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">鐢ㄦ埛缁熻淇℃伅</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">娲昏穬鐢ㄦ埛</span>
                                        <span class="badge bg-primary" id="sidebarActiveUsers">-</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">骞冲潎涓嬭浇閲?/span>
                                        <span class="badge bg-info" id="avgDownloads">-</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">鏈€楂樹笅杞界敤鎴?/span>
                                        <span class="badge bg-success" id="topUser">-</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">骞冲潎鏂囦欢澶у皬</span>
                                        <span class="badge bg-warning" id="avgFileSize">-</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <small class="text-muted">鏁版嵁鏇存柊鏃堕棿</small>
                                    <div id="lastUpdateTime" class="fw-bold">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">璇︾粏涓嬭浇鏁版嵁</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="downloadDetailsTable">
                                        <thead>
                                            <tr>
                                                <th>鐢ㄦ埛鍚?/th>
                                                <th>涓嬭浇娆℃暟</th>
                                                <th>鏂囦欢鏁伴噺</th>
                                                <th>鎬诲ぇ灏?(MB)</th>
                                                <th>骞冲潎鏂囦欢澶у皬 (MB)</th>
                                                <th>鏈€鍚庝笅杞芥椂闂?/th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadDetailsBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">绛夊緟鏁版嵁鍔犺浇...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 寮曞叆Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let downloadTrendChart = null;
    let userDistributionChart = null;
    let downloadData = {};

    // 浠巆ookie涓幏鍙朇SRF浠ょ墝
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }
    
    // 浠嶢PI鑾峰彇涓嬭浇鏁版嵁锛堝彧浣跨敤鐪熷疄鏁版嵁锛?
    async function fetchDownloadData(days, user = 'all') {
        try {
            // 鏋勫缓API URL
            const url = new URL('/api/download-analytics/', window.location.origin);
            url.searchParams.append('days', days);
            if (user !== 'all') {
                url.searchParams.append('user', user);
            }
            
            console.log('鍙戦€佽姹傚埌:', url);
            
            // 鍙戦€佽姹傚埌鍚庣API
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            console.log('鍝嶅簲鐘舵€?', response.status);
            
            if (!response.ok) {
                // 妫€鏌ユ槸鍚︽槸閲嶅畾鍚?
                if (response.redirected) {
                    console.error('API璇锋眰琚噸瀹氬悜锛屽彲鑳芥槸鐧诲綍浼氳瘽杩囨湡');
                    showToast('鐧诲綍浼氳瘽宸茶繃鏈燂紝璇烽噸鏂扮櫥褰?, 'danger');
                    return null;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // 妫€鏌ュ搷搴斿唴瀹圭被鍨?
            const contentType = response.headers.get('content-type');
            console.log('鍝嶅簲鍐呭绫诲瀷:', contentType);
            
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('鍝嶅簲涓嶆槸JSON鏍煎紡:', text.substring(0, 100) + '...');
                showToast('鏈嶅姟鍣ㄨ繑鍥炰簡闈濲SON鍝嶅簲锛岃妫€鏌ユ湇鍔″櫒鏃ュ織', 'danger');
                return null;
            }
            
            const data = await response.json();
            console.log('鑾峰彇鍒扮殑鏁版嵁:', data);
            return data;
        } catch (error) {
            console.error('鑾峰彇涓嬭浇鏁版嵁澶辫触:', error);
            showToast('鑾峰彇涓嬭浇鏁版嵁澶辫触锛岃妫€鏌ョ綉缁滆繛鎺ユ垨鑱旂郴绠＄悊鍛?, 'danger');
            return null;
        }
    }

    // 鏄剧ず鍔犺浇鐘舵€?
    function showLoading() {
        const loadingHtml = '<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">鍔犺浇涓?..</span></div><p class="mt-2">姝ｅ湪浠庢湇鍔″櫒鑾峰彇鏁版嵁...</p></div>';
        
        const trendContainer = document.getElementById('trendChartContainer');
        const distributionContainer = document.getElementById('distributionChartContainer');
        
        if (trendContainer) {
            trendContainer.innerHTML = loadingHtml;
        }
        if (distributionContainer) {
            distributionContainer.innerHTML = loadingHtml;
        }
    }

    // 鏄剧ず閿欒鐘舵€?
    function showError(message = '鏁版嵁鑾峰彇澶辫触') {
        const errorHtml = `<div class="text-center p-4 text-danger">
            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
            <p class="mt-2">${message}</p>
            <button class="btn btn-outline-primary btn-sm" onclick="updateDownloadChart()">
                <i class="bi bi-arrow-clockwise me-1"></i>閲嶈瘯
            </button>
        </div>`;
        
        const trendContainer = document.getElementById('trendChartContainer');
        const distributionContainer = document.getElementById('distributionChartContainer');
        
        if (trendContainer) {
            trendContainer.innerHTML = errorHtml;
        }
        if (distributionContainer) {
            distributionContainer.innerHTML = errorHtml;
        }
    }

    // 鏄剧ず鏃犳暟鎹姸鎬?
    function showNoData() {
        const noDataHtml = '<div class="text-center p-4 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-2">鏆傛棤鏁版嵁</p></div>';
        
        const trendContainer = document.getElementById('trendChartContainer');
        const distributionContainer = document.getElementById('distributionChartContainer');
        
        if (trendContainer) {
            trendContainer.innerHTML = noDataHtml;
        }
        if (distributionContainer) {
            distributionContainer.innerHTML = noDataHtml;
        }
    }

    // 閲嶆柊鍒涘缓canvas鍏冪礌
    function recreateCanvas() {
        const trendContainer = document.getElementById('trendChartContainer');
        const distributionContainer = document.getElementById('distributionChartContainer');
        
        if (trendContainer) {
            trendContainer.innerHTML = '<canvas id="downloadTrendChart" width="400" height="200"></canvas>';
        }
        if (distributionContainer) {
            distributionContainer.innerHTML = '<canvas id="userDistributionChart" width="300" height="200"></canvas>';
        }
    }

    // 鍒濆鍖栫敤鎴风瓫閫夊櫒
    async function initializeUserFilter(data, selectedUser = 'all') {
        const userFilter = document.getElementById('userFilter');
        
        if (!data || !data.users) {
            userFilter.innerHTML = '<option value="all">鍏ㄩ儴鐢ㄦ埛</option>';
            return;
        }
        
        const users = data.users || [];
        
        // 娓呯┖鐜版湁閫夐」锛堜繚鐣?鍏ㄩ儴鐢ㄦ埛"锛?
        userFilter.innerHTML = '<option value="all">鍏ㄩ儴鐢ㄦ埛</option>';
        
        // 娣诲姞鐢ㄦ埛閫夐」
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            if (user === selectedUser) {
                option.selected = true;
            }
            userFilter.appendChild(option);
        });
    }

    // 鏇存柊涓嬭浇鍥捐〃
    async function updateDownloadChart() {
        const timeRange = document.getElementById('timeRange').value;
        const userFilter = document.getElementById('userFilter').value;
        
        // 鏄剧ず鍔犺浇鐘舵€?
        showLoading();
        
        try {
            // 鑾峰彇鏁版嵁
            console.log('寮€濮嬭幏鍙栨暟鎹紝鍙傛暟:', { timeRange, userFilter });
            const data = await fetchDownloadData(timeRange, userFilter);
            
            console.log('API杩斿洖鏁版嵁:', data);
            
            if (!data) {
                // 鏁版嵁鑾峰彇澶辫触
                showError('鏃犳硶杩炴帴鍒版湇鍔″櫒');
                clearStatistics();
                clearDetailsTable();
                return;
            }
            
            // 妫€鏌ユ暟鎹槸鍚︿负绌?
            if (!data.summary || !data.downloads || Object.keys(data.downloads).length === 0) {
                console.log('鏁版嵁涓虹┖锛屾樉绀?鏆傛棤鏁版嵁"');
                showNoData();
                // 鍗充娇鏁版嵁涓虹┖锛屼篃瑕佹洿鏂扮粺璁″崱鐗囨樉绀?鍊?
                document.getElementById('totalDownloads').textContent = '0';
                document.getElementById('totalFiles').textContent = '0';
                document.getElementById('totalSize').textContent = '0.0 MB';
                document.getElementById('activeUsers').textContent = '0';
                document.getElementById('sidebarActiveUsers').textContent = '0';
                document.getElementById('avgDownloads').textContent = '0';
                document.getElementById('topUser').textContent = '-';
                document.getElementById('avgFileSize').textContent = '0.00 MB';
                // 鏇存柊鏃堕棿
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('lastUpdateTime').textContent = timeString;
                
                // 娓呯┖琛ㄦ牸
                const tbody = document.getElementById('downloadDetailsBody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">鏆傛棤鏁版嵁</td></tr>';
                return;
            }
            
            downloadData = data;
            
            // 閲嶆柊鍒涘缓canvas鍏冪礌
            recreateCanvas();
            
            // 绛夊緟DOM鏇存柊
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // 鏇存柊鐢ㄦ埛绛涢€夊櫒
            // 鏇存柊鐢ㄦ埛绛涢€夊櫒骞朵繚鎸佸綋鍓嶉€変腑鐘舵€?
            await initializeUserFilter(data, userFilter);
            
            // 鏇存柊缁熻鍗＄墖
            updateStatistics(data);
            
            // 鏇存柊鍥捐〃
            updateTrendChart(data.trend);
            updateDistributionChart(data, userFilter);
            
            // 鏇存柊璇︾粏鏁版嵁琛ㄦ牸
            updateDetailsTable(data, userFilter);
            
        } catch (error) {
            console.error('鏇存柊鍥捐〃澶辫触:', error);
            showError('鏁版嵁澶勭悊澶辫触');
            clearStatistics();
            clearDetailsTable();
        }
    }

    // 鍒濆鍖栭〉闈?
    document.addEventListener('DOMContentLoaded', function() {
        console.log('椤甸潰鍔犺浇瀹屾垚锛屽紑濮嬪垵濮嬪寲...');
        
        // 妫€鏌ユ槸鍚︾櫥褰?
        console.log('褰撳墠椤甸潰URL:', window.location.href);
        console.log('CSRF浠ょ墝:', getCookie('csrftoken'));
        
        // 寤惰繜鍒濆鍖栦互纭繚鎵€鏈夎祫婧愬姞杞藉畬鎴?
        setTimeout(() => {
            updateDownloadChart();
        }, 500);
    });

    // 娓呯┖缁熻鏁版嵁
    function clearStatistics() {
        document.getElementById('totalDownloads').textContent = '-';
        document.getElementById('totalFiles').textContent = '-';
        document.getElementById('totalSize').textContent = '-';
        document.getElementById('activeUsers').textContent = '-';
        
        document.getElementById('sidebarActiveUsers').textContent = '-';
        document.getElementById('avgDownloads').textContent = '-';
        document.getElementById('topUser').textContent = '-';
        document.getElementById('avgFileSize').textContent = '-';
        document.getElementById('lastUpdateTime').textContent = '-';
    }

    // 娓呯┖璇︾粏鏁版嵁琛ㄦ牸
    function clearDetailsTable() {
        const tbody = document.getElementById('downloadDetailsBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">鏆傛棤鏁版嵁</td></tr>';
    }

    // 鏇存柊缁熻鍗＄墖
    function updateStatistics(data) {
        const summary = data.summary || {};
        const downloads = data.downloads || {};
        
        document.getElementById('totalDownloads').textContent = summary.totalDownloads || 0;
        document.getElementById('totalFiles').textContent = summary.totalFiles || 0;
        document.getElementById('totalSize').textContent = (summary.totalSize || 0).toFixed(1) + ' MB';
        document.getElementById('activeUsers').textContent = summary.activeUsers || 0;
        
        // 鏇存柊渚ц竟鏍忕敤鎴蜂俊鎭?
        updateSidebarInfo(data);
    }

    // 鏇存柊渚ц竟鏍忕敤鎴蜂俊鎭?
    function updateSidebarInfo(data) {
        const summary = data.summary || {};
        const downloads = data.downloads || {};
        
        // 娲昏穬鐢ㄦ埛鏁?
        document.getElementById('sidebarActiveUsers').textContent = summary.activeUsers || 0;
        
        // 璁＄畻骞冲潎涓嬭浇閲?
        const totalUsers = Object.keys(downloads).length;
        const avgDownloads = totalUsers > 0 ? Math.round((summary.totalDownloads || 0) / totalUsers) : 0;
        document.getElementById('avgDownloads').textContent = avgDownloads;
        
        // 鎵惧嚭鏈€楂樹笅杞界敤鎴?
        let topUser = '-';
        let maxDownloads = 0;
        Object.keys(downloads).forEach(username => {
            if (downloads[username].count > maxDownloads) {
                maxDownloads = downloads[username].count;
                topUser = username;
            }
        });
        document.getElementById('topUser').textContent = topUser;
        
        // 璁＄畻骞冲潎鏂囦欢澶у皬
        const avgFileSize = (summary.totalFiles || 0) > 0 ? 
            ((summary.totalSize || 0) / (summary.totalFiles || 0)).toFixed(2) : '0.00';
        document.getElementById('avgFileSize').textContent = avgFileSize + ' MB';
        
        // 鏇存柊鏃堕棿
        const now = new Date();
        const timeString = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('lastUpdateTime').textContent = timeString;
    }

    // 鏇存柊瓒嬪娍鍥捐〃
    function updateTrendChart(trendData) {
        const canvas = document.getElementById('downloadTrendChart');
        if (!canvas) {
            console.error('鎵句笉鍒拌秼鍔垮浘canvas鍏冪礌');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        if (downloadTrendChart) {
            downloadTrendChart.destroy();
        }
        
        if (!trendData || trendData.length === 0) {
            showNoData();
            return;
        }
        
        downloadTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.map(item => item.date),
                datasets: [{
                    label: '涓嬭浇娆℃暟',
                    data: trendData.map(item => item.downloads),
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: '涓嬭浇澶у皬 (MB)',
                    data: trendData.map(item => item.size),
                    borderColor: '#ff6b35',
                    backgroundColor: 'rgba(255, 107, 53, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '鏃ユ湡'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '涓嬭浇娆℃暟'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '涓嬭浇澶у皬 (MB)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });
    }

    // 鏇存柊鍒嗗竷鍥捐〃
    function updateDistributionChart(data, userFilter) {
        const canvas = document.getElementById('userDistributionChart');
        if (!canvas) {
            console.error('鎵句笉鍒板垎甯冨浘canvas鍏冪礌');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        
        if (userDistributionChart) {
            userDistributionChart.destroy();
        }
        
        let chartData, labels;
        const downloads = data.downloads || {};
        
        if (userFilter === 'all') {
            labels = Object.keys(downloads);
            chartData = Object.values(downloads).map(user => user.count);
        } else {
            const user = downloads[userFilter];
            if (user) {
                labels = ['涓嬭浇娆℃暟', '鏂囦欢鏁伴噺'];
                chartData = [user.count, user.files];
            } else {
                labels = [];
                chartData = [];
            }
        }
        
        if (chartData.length === 0) {
            showNoData();
            return;
        }
        
        const colors = [
            '#0066cc', '#ff6b35', '#28a745', '#ffc107', 
            '#dc3545', '#6f42c1', '#20c997', '#fd7e14'
        ];
        
        userDistributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: chartData,
                    backgroundColor: colors.slice(0, chartData.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }

    // 鏇存柊璇︾粏鏁版嵁琛ㄦ牸
    function updateDetailsTable(data, userFilter) {
        const tbody = document.getElementById('downloadDetailsBody');
        tbody.innerHTML = '';
        
        const downloads = data.downloads || {};
        let users;
        
        if (userFilter === 'all') {
            users = Object.keys(downloads);
        } else {
            users = downloads[userFilter] ? [userFilter] : [];
        }
        
        if (users.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" class="text-center text-muted">鏆傛棤鏁版嵁</td>';
            tbody.appendChild(row);
            return;
        }
        
        users.forEach(username => {
            const user = downloads[username];
            const avgSize = user.files > 0 ? (user.size / user.files).toFixed(2) : '0.00';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-primary">${username}</span></td>
                <td>${user.count}</td>
                <td>${user.files}</td>
                <td>${user.size.toFixed(1)}</td>
                <td>${avgSize}</td>
                <td><small class="text-muted">${user.lastDownload}</small></td>
            `;
            tbody.appendChild(row);
        });
    }

    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toast = new bootstrap.Toast(toastContainer.lastElementChild);
        toast.show();
    }
</script>
{% endblock %}


