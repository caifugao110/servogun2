{% extends 'base.html' %}

{% block title %}搜索结果 - 小原焊钳选型数据库{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 搜索结果头部 -->
        <div class="results-header fade-in-up">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-search me-2"></i>
                        搜索结果
                    </h2>
                    <p class="mb-0">共找到 {{ total_results }} 个匹配的产品</p>
                </div>
                <div>
                    <a href="{% url 'clamps:search' %}" class="btn btn-light">
                        <i class="bi bi-arrow-left me-2"></i>
                        返回搜索
                    </a>
                </div>
            </div>
        </div>
        
        {% if page_obj %}
            <!-- 搜索结果表格 -->
            <div class="card fade-in-up">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">搜索结果列表</h5>
                    <div>
                        <div class="input-group">
                            <select class="form-select form-select-sm" id="fileTypeSelect">
                                <option value="dwg">仅DWG</option>
                                <option value="step">仅STEP</option>
                                <option value="both">DWG和STEP</option>
                            </select>
                            <button id="batchDownloadBtn" class="btn btn-primary btn-sm" disabled>
                                <i class="bi bi-download me-2"></i>批量下载选中项
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th width="5%"><input type="checkbox" id="selectAll"></th>
                                    <th width="8%">序号</th>
                                    <th width="15%" class="highlight-field">描述</th>
                                    <th width="15%" class="highlight-field">图号1(o)</th>
                                    <th width="10%" class="highlight-field">喉深</th>
                                    <th width="10%" class="highlight-field">喉宽</th>
                                    <th width="15%" class="highlight-field">变压器</th>
                                    <th width="10%">预览图</th>
                                    <th width="15%">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in page_obj %}
                                    <tr class="product-row" data-product-id="{{ product.id }}">
                                        <td><input type="checkbox" class="product-checkbox" value="{{ product.id }}"></td>
                                        <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.description|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.drawing_no_1|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.throat_depth %}
                                                    {{ product.throat_depth }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {% if product.throat_width %}
                                                    {{ product.throat_width }}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="highlight-field" onclick="viewDetail({{ product.id }})">
                                                {{ product.transformer|default:"--" }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if product.bmp_file_path %}
                                                <img src="{{ MEDIA_URL }}{{ product.bmp_file_path }}" 
                                                     class="image-preview" 
                                                     onclick="previewImage('{{ MEDIA_URL }}{{ product.bmp_file_path }}', '{{ product.drawing_no_1 }}')"
                                                     alt="产品预览图"
                                                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 4px;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                <span class="text-muted" style="display: none;">无图片</span>
                                            {% else %}
                                                <span class="text-muted">无图片</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <a href="{% url 'clamps:product_detail' product.id %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-eye me-1"></i>详情
                                                </a>
                                                {% if product.dwg_file_path %}
                                                    <a href="{% url 'clamps:download_file' product.id 'dwg' %}" 
                                                       class="btn btn-outline-success btn-sm">
                                                        <i class="bi bi-download me-1"></i>DWG
                                                    </a>
                                                {% endif %}
                                                {% if product.step_file_path %}
                                                    <a href="{% url 'clamps:download_file' product.id 'step' %}" 
                                                       class="btn btn-outline-info btn-sm">
                                                        <i class="bi bi-download me-1"></i>STEP
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 分页导航 -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="搜索结果分页" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page=1">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.previous_page_number }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.next_page_number }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in query_params.items %}{{ key }}={{ value }}&{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <div class="text-center text-muted">
                    第 {{ page_obj.number }} 页，共 {{ page_obj.paginator.num_pages }} 页
                    (显示第 {{ page_obj.start_index }} - {{ page_obj.end_index }} 条记录，共 {{ total_results }} 条)
                </div>
            {% endif %}
            
        {% else %}
            <!-- 无搜索结果 -->
            <div class="text-center py-5 fade-in-up">
                <div class="card">
                    <div class="card-body py-5">
                        <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-muted">未找到匹配的产品</h3>
                        <p class="text-muted">请尝试调整搜索条件或使用不同的关键词</p>
                        <a href="{% url 'clamps:search' %}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-2"></i>
                            重新搜索
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- 搜索条件摘要 -->
        {% if query_params %}
            <div class="card mt-4 fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        当前搜索条件
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for key, value in query_params.items %}
                            {% if value %}
                                <div class="col-md-3 mb-2">
                                    <span class="badge bg-primary">
                                        {{ key }}: {{ value }}
                                    </span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- 图片预览模态框 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">产品预览图</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="产品预览图" class="img-fluid" style="max-height: 500px;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function viewDetail(productId) {
        window.location.href = `/product/${productId}/`;
    }
    
    // 图片预览功能
    function previewImage(imageSrc, productName) {
        const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
        const previewImg = document.getElementById('previewImage');
        const modalTitle = document.getElementById('imagePreviewModalLabel');
        
        previewImg.src = imageSrc;
        modalTitle.textContent = `产品预览图 - ${productName || '未知产品'}`;
        modal.show();
    }
    
    // 批量下载功能
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const productCheckboxes = document.querySelectorAll('.product-checkbox');
        const batchDownloadBtn = document.getElementById('batchDownloadBtn');

        if (selectAllCheckbox && batchDownloadBtn) {
            selectAllCheckbox.addEventListener('change', function() {
                productCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                toggleBatchDownloadButton();
            });

            productCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (!this.checked) {
                        selectAllCheckbox.checked = false;
                    }
                    toggleBatchDownloadButton();
                });
            });

            function toggleBatchDownloadButton() {
                const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
                batchDownloadBtn.disabled = checkedCount === 0;
            }

            batchDownloadBtn.addEventListener("click", function() {
                const selectedProductIds = Array.from(document.querySelectorAll(".product-checkbox:checked"))
                                                .map(checkbox => checkbox.value);
                const selectedFileType = document.getElementById("fileTypeSelect").value;

                if (selectedProductIds.length > 0) {
                    const downloadUrl = `/batch_download/${selectedFileType}/?ids=${selectedProductIds.join(",")}`;
                    window.location.href = downloadUrl;
                    showToast(`正在批量下载 ${selectedProductIds.length} 个产品下的 ${selectedFileType.toUpperCase()} 文件...`, "info");
                } else {
                    showToast("请选择至少一个产品进行批量下载。", "warning");
                }
            });
        }
        
        // 表格行点击效果
        const rows = document.querySelectorAll('.product-row');
        rows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(0, 102, 204, 0.05)';
            });
            
            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
        
        // 下载文件时显示提示
        document.querySelectorAll('a[href*="download"]').forEach(link => {
            link.addEventListener('click', function() {
                const fileName = this.textContent.trim();
                showToast(`正在下载 ${fileName} 文件...`, 'info');
            });
        });
    });
    
    function showToast(message, type = 'info') {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toast = new bootstrap.Toast(toastContainer.lastElementChild);
        toast.show();
    }
</script>
{% endblock %}
